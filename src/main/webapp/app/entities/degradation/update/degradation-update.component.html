<div class="container mt-4">
  <h2 *ngIf="degradation?.id; else creationTitle">Modifier la Dégradation</h2>
  <ng-template #creationTitle><h2>Créer une Dégradation</h2></ng-template>

  <form [formGroup]="editForm" (ngSubmit)="save()">
    <!-- Upload du fichier Excel -->
    <div class="mb-3">
      <label for="excelFile" class="form-label">Importer un fichier Excel</label>
      <input type="file" class="form-control" id="excelFile" (change)="onFileChange($event)" accept=".xlsx, .xls" />
    </div>

    <!-- Sélection Localité -->
    <div class="mb-3">
      <label for="selectLocalite" class="form-label">Localité</label>
      <select id="selectLocalite" #selectLocalite class="form-select" (change)="onLocaliteChange(selectLocalite.value)">
        <option value="">-- Sélectionnez une localité --</option>
        <option *ngFor="let loc of localites" [value]="loc">{{ loc }}</option>
      </select>
    </div>

    <!-- Sélection Zone -->
    <div class="mb-3">
      <label for="selectZone" class="form-label">Zone</label>
      <select
        id="selectZone"
        #selectZone
        class="form-select"
        (change)="onZoneChange(selectZone.value)"
        [disabled]="zonesFiltered.length === 0"
      >
        <option value="">-- Sélectionnez une zone --</option>
        <option *ngFor="let z of zonesFiltered" [value]="z.zone">{{ z.zone }}</option>
      </select>
    </div>

    <div class="row">
      <div class="col-md-6 pe-md-4 border-end">
        <div class="mb-3">
          <label for="numero" class="form-label">Numéro</label>
          <input id="numero" type="text" class="form-control" formControlName="numero" required />
        </div>

        <div class="mb-3">
          <label for="localite" class="form-label">Localité (formulaire)</label>
          <input id="localite" type="text" class="form-control" formControlName="localite" readonly />
        </div>

        <div class="mb-3">
          <label for="contactTemoin" class="form-label">Contact Témoin</label>
          <input id="contactTemoin" type="text" class="form-control" formControlName="contactTemoin" />
        </div>

        <div class="mb-3">
          <label for="typeAnomalie" class="form-label">Type d’anomalie</label>
          <select id="typeAnomalie" class="form-select" formControlName="typeAnomalie">
            <option *ngFor="let type of typeAnomalieValues" [value]="type">{{ type }}</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="statut" class="form-label">Statut</label>
          <select id="statut" class="form-select" formControlName="statut">
            <option *ngFor="let s of statutValues" [value]="s">{{ s }}</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="actionsEffectuees" class="form-label">Actions effectuées</label>
          <textarea id="actionsEffectuees" class="form-control" formControlName="actionsEffectuees"></textarea>
        </div>
      </div>

      <div class="col-md-6 ps-md-4">
        <div class="mb-3">
          <label for="priorite" class="form-label">Priorité</label>
          <select id="priorite" class="form-select" formControlName="priorite">
            <option *ngFor="let p of prioriteValues" [value]="p">{{ p }}</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="problem" class="form-label">Problème</label>
          <input id="problem" type="text" class="form-control" formControlName="problem" />
        </div>

        <div class="mb-3">
          <label for="porteur" class="form-label">Porteur</label>
          <input id="porteur" type="text" class="form-control" formControlName="porteur" />
        </div>

        <div class="mb-3">
          <label for="dateDetection" class="form-label">Date de détection</label>
          <input id="dateDetection" type="date" class="form-control" formControlName="dateDetection" />
        </div>

        <div class="mb-3">
          <label for="commentaire" class="form-label">Commentaire</label>
          <textarea id="commentaire" class="form-control" formControlName="commentaire"></textarea>
        </div>

        <div class="mb-3">
          <label for="utilisateur" class="form-label">Utilisateur</label>
          <select id="utilisateur" class="form-select" formControlName="utilisateur">
            <option [ngValue]="null">-- Aucun --</option>
            <option *ngFor="let u of utilisateursSharedCollection" [ngValue]="u">{{ u.nom }} {{ u.prenom }}</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="site" class="form-label">Site</label>
          <select id="site" class="form-select" formControlName="site">
            <option [ngValue]="null">-- Aucun --</option>
            <option *ngFor="let s of sitesSharedCollection" [ngValue]="s">
              {{ s.nomSite }}
            </option>
          </select>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-3">
      <button type="button" class="btn btn-secondary" (click)="previousState()">Annuler</button>
      <button type="submit" class="btn btn-primary" [disabled]="editForm.invalid || isSaving">
        {{ isSaving ? 'Enregistrement...' : 'Enregistrer' }}
      </button>

      <button type="button" (click)="onLocaliteClicked()" class="btn btn-sm btn-primary">Afficher sur la carte</button>
    </div>
  </form>
</div>

<style>
  body {
    font-family: 'Roboto', sans-serif;
    background: #f9fafb;
    color: #2d3748;
    margin: 0;
    padding: 0;
  }

  .container {
    max-width: 800px;
    margin: 2rem auto;
    padding: 0 15px;
  }

  h2 {
    color: #2d3748;
    font-weight: 600;
    text-align: center;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid #ff7900;
    padding-bottom: 0.5rem;
  }

  .form-label {
    font-weight: 500;
    color: #2d3748;
    margin-bottom: 0.5rem;
  }

  input.form-control,
  select.form-select,
  textarea.form-control {
    width: 100%;
    padding: 0.75rem;
    font-size: 1rem;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    background: #fff;
    box-sizing: border-box;
    transition: all 0.3s ease;
    font-family: 'Roboto', sans-serif;
    color: #2d3748;
  }

  input.form-control::placeholder,
  textarea.form-control::placeholder {
    color: #a0aec0;
    font-style: italic;
  }

  input.form-control:focus,
  select.form-select:focus,
  textarea.form-control:focus {
    border-color: #ff7900;
    box-shadow: 0 0 0 3px rgba(255, 121, 0, 0.2);
    outline: none;
  }

  textarea.form-control {
    min-height: 120px;
    resize: vertical;
  }

  .btn {
    padding: 0.6rem 1.5rem;
    font-weight: 500;
    border-radius: 5px;
    transition: background 0.3s ease;
  }

  .btn-primary {
    background-color: #ff7900;
    border: none;
    color: white;
  }

  .btn-primary:hover {
    background-color: #e56b00;
  }

  .btn-secondary {
    background-color: #718096;
    border: none;
    color: white;
  }

  .btn-secondary:hover {
    background-color: #4a5568;
  }

  @media (max-width: 768px) {
    .btn {
      width: 100%;
    }
  }
</style>
